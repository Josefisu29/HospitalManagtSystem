<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nurse - Patient Vitals & Profile</title>
    <link rel="stylesheet" href="../css/all.css" />
    <link rel="stylesheet" href="../css/common.css" />
    <link rel="stylesheet" href="../css/security.css" />
    <style>
      :root {
        --primary: #0052cc;
        --bg: #f9fbfd;
        --card-bg: #fff;
        --transition: 0.3s ease;
      }
      body {
        font-family: Arial, sans-serif;
        background: var(--bg);
        margin: 0;
      }
      header {
        background: var(--card-bg);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .header-inner {
        display: flex;
        justify-content: space-between;
        width: 100%;
        align-items: center;
      }
      .brand {
        font-size: 1.5rem;
        font-weight: bold;
      }
      nav {
        background: var(--primary);
        padding: 0.5rem;
      }
      nav ul {
        list-style: none;
        display: flex;
        gap: 1rem;
        margin: 0;
        padding: 0;
      }
      nav ul li a {
        color: white;
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
      }
      nav ul li a.active,
      nav ul li a:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      main {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
      }
      .card {
        background: var(--card-bg);
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .form-group input[type="file"] {
        padding: 3px;
      }
      .form-group textarea {
        resize: vertical;
        min-height: 100px;
      }
      button {
        padding: 10px 20px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #0047b3;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      #error-message,
      #success-message {
        text-align: center;
        margin-bottom: 1rem;
        display: none;
        padding: 0.5rem;
        border-radius: 4px;
      }
      #error-message {
        background: #f14668;
        color: white;
      }
      #success-message {
        background: #48c774;
        color: white;
      }
      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #dc3545;
        display: inline-block;
        margin-left: 0.5rem;
      }
      .status-indicator.online {
        background: #28a745;
      }
      .status-indicator.disconnected {
        background: #6c757d;
      }
      .loading-spinner {
        width: 24px;
        height: 24px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: auto;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }
      th,
      td {
        padding: 0.7rem;
        border-bottom: 1px solid #e2e8f0;
        text-align: left;
      }
      th {
        background: #f1f5f9;
        color: #2d3a4b;
        cursor: pointer;
      }
      th:hover {
        background: #e2e8f0;
      }
      .sort-icon::after {
        content: "↕";
        margin-left: 5px;
      }
      .sort-asc::after {
        content: "↑";
      }
      .sort-desc::after {
        content: "↓";
      }
      .filter-input {
        margin-bottom: 1rem;
        padding: 8px;
        width: 100%;
        max-width: 300px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .action-btn {
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .delete-btn {
        background: #dc3545;
        color: white;
      }
      .delete-btn:hover {
        background: #c82333;
      }
      .form-group input.invalid {
        border-color: #dc3545;
        background-color: #fff8f8;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/list.js@2.3.1/dist/list.min.js"></script>
  </head>
  <body>
    <div id="loading" class="loading-spinner" style="display: none"></div>
    <div id="error-message"></div>
    <div id="success-message"></div>
    <header>
      <div class="header-inner">
        <div class="brand">Nurse Dashboard</div>
        <div style="display: flex; align-items: center">
          <div id="greeting" class="greeting">Good Morning,</div>
          <div id="statusIndicator" class="status-indicator disconnected"></div>
          <button id="logoutBtn" class="btn" style="margin-left: 1rem">
            Logout
          </button>
        </div>
      </div>
    </header>
    <nav>
      <ul>
        <li><a href="#vitals" class="active">Vitals Dashboard</a></li>
        <li><a href="#tasks">Tasks</a></li>
        <li><a href="#profile">Profile</a></li>
      </ul>
    </nav>
    <main>
      <section id="vitals" class="card">
        <h2>Patient Vitals Dashboard</h2>
        <form id="vitalsForm">
          <div class="form-group">
            <label for="patientId">Patient</label>
            <select id="patientId" required>
              <option value="">Select Patient</option>
            </select>
          </div>
          <div class="form-group">
            <label for="heartRate">Heart Rate (bpm)</label>
            <input type="number" id="heartRate" min="30" max="200" required />
          </div>
          <div class="form-group">
            <label for="bloodPressure">Blood Pressure (mmHg)</label>
            <input
              type="text"
              id="bloodPressure"
              placeholder="e.g., 120/80"
              required
              pattern="^\\d{2,3}/\\d{2,3}$"
            />
          </div>
          <div class="form-group">
            <label for="temperature">Temperature (°C)</label>
            <input
              type="number"
              id="temperature"
              step="0.1"
              min="35"
              max="42"
              required
            />
          </div>
          <div class="form-group">
            <label for="vitalFile">Vital Report (PDF)</label>
            <input type="file" id="vitalFile" accept=".pdf" />
          </div>
          <button type="submit">Record Vitals</button>
        </form>
        <h3>Vitals History</h3>
        <input
          type="text"
          id="vitalsFilter"
          class="search filter-input"
          placeholder="Filter by Patient Name or Date"
        />
        <div id="vitals-list">
          <table id="vitals-table">
            <thead>
              <tr>
                <th data-sort="patientName">Patient Name</th>
                <th data-sort="heartRate">Heart Rate</th>
                <th data-sort="bloodPressure">Blood Pressure</th>
                <th data-sort="temperature">Temperature</th>
                <th data-sort="date">Date</th>
                <th data-sort="recordedBy">Recorded By</th>
                <th>File</th>
              </tr>
            </thead>
            <tbody class="list"></tbody>
          </table>
        </div>
      </section>
      <section id="tasks" class="card" style="display: none">
        <h2>Assigned Tasks</h2>
        <input
          type="text"
          id="tasksFilter"
          class="search filter-input"
          placeholder="Filter by Patient Name or Description"
        />
        <div id="tasks-list">
          <table id="tasks-table">
            <thead>
              <tr>
                <th data-sort="description">Description</th>
                <th data-sort="patientName">Patient Name</th>
                <th data-sort="status">Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody class="list"></tbody>
          </table>
        </div>
      </section>
      <section id="profile" class="card" style="display: none">
        <h2>Nurse Profile</h2>
        <form id="profileForm">
          <div class="form-group">
            <label for="nurseId">Nurse ID</label>
            <input type="text" id="nurseId" readonly />
          </div>
          <div class="form-group">
            <label for="firstName">First Name</label>
            <input type="text" id="firstName" required />
          </div>
          <div class="form-group">
            <label for="lastName">Last Name</label>
            <input type="text" id="lastName" required />
          </div>
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" readonly />
          </div>
          <div class="form-group">
            <label for="licenseNumber">License Number</label>
            <input type="text" id="licenseNumber" required />
          </div>
          <div class="form-group">
            <label for="hospital">Hospital</label>
            <input type="text" id="hospital" />
          </div>
          <div class="form-group">
            <label for="phone">Phone</label>
            <input type="tel" id="phone" pattern="^\\+?\\d{10,15}$" />
          </div>
          <div class="form-group">
            <label for="bio">Bio</label>
            <textarea id="bio"></textarea>
          </div>
          <button type="submit">Save Profile</button>
        </form>
      </section>
    </main>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        onSnapshot,
        doc,
        updateDoc,
        deleteDoc,
        getDoc,
        query,
        where,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCpMkpU9YeB3HNpzk0_fwswSf9TQwb_Xdg",
        authDomain: "hospitalmanagtsystem.firebaseapp.com",
        projectId: "hospitalmanagtsystem",
        storageBucket: "hospitalmanagtsystem.firebasestorage.app",
        messagingSenderId: "771158568788",
        appId: "1:771158568788:web:e47f16ea2577fa1e8762c1",
        databaseURL: "https://hospitalmanagtsystem-default-rtdb.firebaseio.com",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // DOM Elements
      const loading = document.getElementById("loading");
      const errorMessage = document.getElementById("error-message");
      const successMessage = document.getElementById("success-message");
      const greeting = document.getElementById("greeting");
      const statusIndicator = document.getElementById("statusIndicator");
      const logoutBtn = document.getElementById("logoutBtn");
      const vitalsForm = document.getElementById("vitalsForm");
      const patientIdSelect = document.getElementById("patientId");
      const tasksTable = document
        .getElementById("tasks-table")
        .querySelector("tbody");
      const profileForm = document.getElementById("profileForm");
      const vitalsFilter = document.getElementById("vitalsFilter");
      const tasksFilter = document.getElementById("tasksFilter");

      // Show Messages
      function showMessage(element, message) {
        element.textContent = message;
        element.style.display = "block";
        setTimeout(() => {
          element.style.display = "none";
          element.textContent = "";
        }, 5000);
      }

      // Authentication Check
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          try {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists() && userDoc.data().role === "nurse") {
              const hour = new Date().getHours();
              let timeOfDay =
                hour < 12 ? "Morning" : hour < 18 ? "Afternoon" : "Evening";
              greeting.textContent = `Good ${timeOfDay}, ${
                userDoc.data().firstName
              }`;
              statusIndicator.classList.remove("disconnected");
              statusIndicator.classList.add("online");
              loadPatients();
              loadVitals();
              loadTasks();
              loadProfile(user.uid);
            } else {
              showMessage(
                errorMessage,
                "Invalid user role. Please contact support."
              );
              await signOut(auth);
              window.location.href = "/index.html";
            }
          } catch (error) {
            showMessage(errorMessage, "Error verifying user: " + error.message);
            await signOut(auth);
          }
        } else {
          window.location.href = "/index.html";
        }
      });

      // Logout
      logoutBtn.addEventListener("click", async () => {
        try {
          await signOut(auth);
          window.location.href = "/index.html";
        } catch (error) {
          showMessage(errorMessage, "Failed to log out: " + error.message);
        }
      });

      // Load Patients
      async function loadPatients() {
        try {
          const q = query(
            collection(db, "users"),
            where("role", "==", "patient")
          );
          onSnapshot(q, (snapshot) => {
            patientIdSelect.innerHTML =
              '<option value="">Select Patient</option>';
            snapshot.forEach((doc) => {
              const user = doc.data();
              const option = document.createElement("option");
              option.value = doc.id;
              option.textContent = `${user.firstName || "N/A"} ${
                user.lastName || "N/A"
              }`;
              option.dataset.name = `${user.firstName || "N/A"} ${
                user.lastName || "N/A"
              }`;
              patientIdSelect.appendChild(option);
            });
          });
        } catch (error) {
          showMessage(
            errorMessage,
            "Failed to load patients: " + error.message
          );
        }
      }

      // Record Vitals
      vitalsForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        loading.style.display = "block";
        const patientId = patientIdSelect.value;
        const heartRate = document.getElementById("heartRate").value;
        const bloodPressure = document.getElementById("bloodPressure").value;
        const temperature = document.getElementById("temperature").value;
        const vitalFile = document.getElementById("vitalFile").files[0];

        try {
          const vitalData = {
            patientId,
            heartRate: parseInt(heartRate),
            bloodPressure,
            temperature: parseFloat(temperature),
            date: new Date(),
            recordedBy: auth.currentUser.uid,
            fileUrl: vitalFile ? "placeholder_url" : null, // Replace with Firebase Storage logic if needed
          };
          await addDoc(collection(db, "vitals"), vitalData);
          showMessage(successMessage, "Vitals recorded successfully!");
          vitalsForm.reset();
        } catch (error) {
          showMessage(
            errorMessage,
            "Failed to record vitals: " + error.message
          );
        } finally {
          loading.style.display = "none";
        }
      });

      // Load Vitals History
      async function loadVitals() {
        try {
          onSnapshot(collection(db, "vitals"), async (snapshot) => {
            const vitalsTable = document
              .getElementById("vitals-table")
              .querySelector("tbody");
            vitalsTable.innerHTML = "";
            for (const doc of snapshot.docs) {
              const v = doc.data();
              const patientDoc = await getDoc(doc(db, "users", v.patientId));
              const patientName = patientDoc.exists()
                ? `${patientDoc.data().firstName || "N/A"} ${
                    patientDoc.data().lastName || "N/A"
                  }`
                : "Unknown";
              const recordedByDoc = await getDoc(
                doc(db, "users", v.recordedBy)
              );
              const recordedByName = recordedByDoc.exists()
                ? `${recordedByDoc.data().firstName || "N/A"} ${
                    recordedByDoc.data().lastName || "N/A"
                  }`
                : "Unknown";
              const row = document.createElement("tr");
              row.innerHTML = `
                <td class="patientName" data-name="${patientName}">${patientName}</td>
                <td class="heartRate">${v.heartRate}</td>
                <td class="bloodPressure">${v.bloodPressure}</td>
                <td class="temperature">${v.temperature}</td>
                <td class="date">${
                  v.date?.toDate()?.toLocaleString() || "N/A"
                }</td>
                <td class="recordedBy">${recordedByName}</td>
                <td class="fileUrl">${
                  v.fileUrl ? '<a href="' + v.fileUrl + '">Download</a>' : "N/A"
                }</td>
              `;
              vitalsTable.appendChild(row);
            }
          });
        } catch (error) {
          showMessage(errorMessage, "Failed to load vitals: " + error.message);
        }
      }

      // Vitals Filter
      vitalsFilter.addEventListener("input", () => {
        const filter = vitalsFilter.value.toLowerCase();
        const rows = document
          .getElementById("vitals-table")
          .querySelector("tbody").rows;
        for (let row of rows) {
          const patientName = row.cells[0].dataset.name.toLowerCase();
          const date = row.cells[4].textContent.toLowerCase();
          row.style.display =
            patientName.includes(filter) || date.includes(filter) ? "" : "none";
        }
      });

      // Load Tasks
      async function loadTasks() {
        try {
          const q = query(
            collection(db, "tasks"),
            where("assignedTo", "==", auth.currentUser.uid)
          );
          onSnapshot(q, async (snapshot) => {
            tasksTable.innerHTML = "";
            for (const doc of snapshot.docs) {
              const t = doc.data();
              const patientDoc = await getDoc(doc(db, "users", t.patientId));
              const patientName = patientDoc.exists()
                ? `${patientDoc.data().firstName || "N/A"} ${
                    patientDoc.data().lastName || "N/A"
                  }`
                : "Unknown";
              const row = document.createElement("tr");
              row.innerHTML = `
                <td class="description">${t.description}</td>
                <td class="patientName" data-name="${patientName}">${patientName}</td>
                <td class="status">
                  <select class="status-select" data-id="${doc.id}">
                    <option value="pending" ${
                      t.status === "pending" ? "selected" : ""
                    }>Pending</option>
                    <option value="completed" ${
                      t.status === "completed" ? "selected" : ""
                    }>Completed</option>
                  </select>
                </td>
                <td><button class="action-btn delete-btn" data-id="${
                  doc.id
                }">Delete</button></td>
              `;
              tasksTable.appendChild(row);
            }
          });
        } catch (error) {
          showMessage(errorMessage, "Failed to load tasks: " + error.message);
        }
      }

      // Tasks Filter
      tasksFilter.addEventListener("input", () => {
        const filter = tasksFilter.value.toLowerCase();
        const rows = document
          .getElementById("tasks-table")
          .querySelector("tbody").rows;
        for (let row of rows) {
          const description = row.cells[0].textContent.toLowerCase();
          const patientName = row.cells[1].dataset.name.toLowerCase();
          row.style.display =
            description.includes(filter) || patientName.includes(filter)
              ? ""
              : "none";
        }
      });

      // Update Task Status
      tasksTable.addEventListener("change", async (e) => {
        if (e.target.classList.contains("status-select")) {
          const taskId = e.target.dataset.id;
          const status = e.target.value;
          try {
            await updateDoc(doc(db, "tasks", taskId), { status });
            showMessage(successMessage, "Task status updated!");
          } catch (error) {
            showMessage(
              errorMessage,
              "Failed to update task: " + error.message
            );
          }
        }
      });

      // Delete Task
      tasksTable.addEventListener("click", async (e) => {
        if (e.target.classList.contains("delete-btn")) {
          const taskId = e.target.dataset.id;
          if (confirm("Are you sure you want to delete this task?")) {
            try {
              await deleteDoc(doc(db, "tasks", taskId));
              showMessage(successMessage, "Task deleted successfully!");
            } catch (error) {
              showMessage(
                errorMessage,
                "Failed to delete task: " + error.message
              );
            }
          }
        }
      });

      // Load Profile
      async function loadProfile(userId) {
        try {
          onSnapshot(doc(db, "users", userId), (docSnap) => {
            if (docSnap.exists()) {
              const user = docSnap.data();
              document.getElementById("nurseId").value = userId;
              document.getElementById("firstName").value = user.firstName || "";
              document.getElementById("lastName").value = user.lastName || "";
              document.getElementById("email").value = user.email || "";
              document.getElementById("licenseNumber").value =
                user.licenseNumber || "";
              document.getElementById("hospital").value = user.hospital || "";
              document.getElementById("phone").value = user.phone || "";
              document.getElementById("bio").value = user.bio || "";
            }
          });
        } catch (error) {
          showMessage(errorMessage, "Failed to load profile: " + error.message);
        }
      }

      // Save Profile
      profileForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        loading.style.display = "block";
        const userId = document.getElementById("nurseId").value;
        const profileData = {
          firstName: document.getElementById("firstName").value,
          lastName: document.getElementById("lastName").value,
          licenseNumber: document.getElementById("licenseNumber").value,
          hospital: document.getElementById("hospital").value,
          phone: document.getElementById("phone").value,
          bio: document.getElementById("bio").value,
        };
        try {
          await updateDoc(doc(db, "users", userId), profileData);
          showMessage(successMessage, "Profile updated successfully!");
        } catch (error) {
          showMessage(
            errorMessage,
            "Failed to update profile: " + error.message
          );
        } finally {
          loading.style.display = "none";
        }
      });

      // Navigation
      document.querySelectorAll("nav a").forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          document
            .querySelectorAll("nav a")
            .forEach((l) => l.classList.remove("active"));
          link.classList.add("active");
          document.querySelectorAll("main section").forEach((section) => {
            section.style.display =
              section.id === link.getAttribute("href").slice(1)
                ? "block"
                : "none";
          });
        });
      });
    </script>
  </body>
</html>
