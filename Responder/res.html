<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HMS Responder Dashboard</title>
    <link rel="stylesheet" href="index.css.css" />
    <link rel="stylesheet" href="../css/common.css" />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
  </head>
  <body>
    <div id="loading">
      <svg
        width="108px"
        height="128px"
        viewBox="0 0 54 64"
        version="1.1"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          class="beat-loader"
          id="beat-loader"
          d="M0.5,38.5 L16,38.5 L19,25.5 L24.5,57.5 L31.5,7.5 L37.5,46.5 L43,38.5 L53.5,38.5"
          stroke="#6c757d"
          stroke-width="2"
          fill="none"
        />
      </svg>
    </div>
    <header>
      <h1>Responder Dashboard</h1>
      <div class="user-info">
        <span id="userGreeting"></span>
        <div id="statusIndicator" class="status-indicator disconnected"></div>
        <button id="logoutBtn" class="btn btn-primary" aria-label="Logout">
          Logout
        </button>
      </div>
    </header>
    <nav>
      <div class="nav-inner">
        <div class="nav-toggle" id="navToggle">☰</div>
        <ul class="nav-menu" id="navMenu">
          <li>
            <a href="Responder.html" class="active" aria-current="page"
              >Dashboard</a
            >
          </li>
          <li><a href="assign.html">Assignment</a></li>
          <li><a href="reports.html">Report</a></li>
          <li><a href="map.html">Map</a></li>
        </ul>
      </div>
    </nav>
    <main>
      <div id="map"></div>
      <section id="emergencyList" class="card">
        <h2>Current Emergencies</h2>
        <div id="error-message"></div>
        <div id="assignedList"></div>
        <h3>Unassigned Emergencies</h3>
        <div id="unassignedList"></div>
      </section>
      <div id="emergencyModal" class="modal">
        <div class="modal-content">
          <span class="close" aria-label="Close modal">×</span>
          <h2 id="modalTitle"></h2>
          <p>Address: <span id="modalAddress"></span></p>
          <p>Requested at: <span id="modalRequestedAt"></span></p>
          <p>Type: <span id="modalType"></span></p>
          <p>Contact: <span id="modalContact"></span></p>
          <p>Coordinates: <span id="modalCoordinates"></span></p>
          <label for="statusSelect">Status:</label>
          <select id="statusSelect" aria-label="Emergency status">
            <option value="Pending">Pending</option>
            <option value="Assigned">Assigned</option>
            <option value="En Route">En Route</option>
            <option value="On Scene">On Scene</option>
            <option value="Resolved">Resolved</option>
          </select>
          <button
            id="saveStatus"
            class="btn btn-primary"
            aria-label="Save status"
          >
            Save Status
          </button>
        </div>
      </div>
      <div id="notifications"></div>
    </main>
    <footer>
      <p>© 2025 Hospital Management System. All rights reserved.</p>
    </footer>
    <script type="module" src="responder.js"></script>
    <script>
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        onSnapshot,
        doc,
        updateDoc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
      import { GeoFirestore } from "geofirestore";

      const firebaseConfig = {
        apiKey: "AIzaSyCpMkpU9YeB3HNpzk0_fwswSf9TQwb_Xdg",
        authDomain: "hospitalmanagtsystem.firebaseapp.com",
        projectId: "hospitalmanagtsystem",
        storageBucket: "hospitalmanagtsystem.firebasestorage.app",
        messagingSenderId: "771158568788",
        appId: "1:771158568788:web:e47f16ea2577fa1e8762c1",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const geoFirestore = new GeoFirestore(db);

      let map;
      let emergencies = [];
      let alarmAudio = new Audio("/sounds/alert.mp3");
      let currentEmergency = null;

      function showLoading() {
        document.getElementById("loading").style.display = "flex";
      }

      function hideLoading() {
        document.getElementById("loading").style.display = "none";
      }

      function showError(message) {
        const errorMsg = document.getElementById("error-message");
        errorMsg.textContent = message;
        errorMsg.style.display = "block";
      }

      function showSuccess(message) {
        showNotification(message, "success");
      }

      function showNotification(message, type = "info") {
        const notifications = document.getElementById("notifications");
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        notification.innerHTML = `<i class="fas fa-${
          type === "success" ? "check-circle" : "exclamation-circle"
        }"></i> ${message}`;
        notifications.appendChild(notification);
        setTimeout(() => notification.remove(), 5000);
      }

      function initMap() {
        map = L.map("map").setView([9.082, 8.6753], 6);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        }).addTo(map);
      }

      function playAlarm() {
        alarmAudio.loop = true;
        alarmAudio
          .play()
          .catch((error) => console.error("Error playing alarm:", error));
        setTimeout(() => alarmAudio.pause(), 5 * 60 * 1000);
      }

      async function fetchNearbyHospitals(lat, lng) {
        const url = new URL(
          "https://maps.googleapis.com/maps/api/place/nearbysearch/json"
        );
        url.search = new URLSearchParams({
          key: "YOUR_API_KEY",
          location: `${lat},${lng}`,
          radius: 2000,
          type: "hospital|clinic",
        });
        try {
          const res = await fetch(url);
          const json = await res.json();
          return json.results;
        } catch (error) {
          console.error("Error fetching hospitals:", error);
          return [];
        }
      }

      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "/index.html";
          return;
        }

        showLoading();
        try {
          const idTokenResult = await user.getIdTokenResult(true);
          if (idTokenResult.claims.role !== "firstResponder") {
            await signOut(auth);
            showError("Unauthorized access. Redirecting to login...");
            setTimeout(() => (window.location.href = "/index.html"), 2000);
            return;
          }

          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (!userDoc.exists()) {
            showError("User data not found.");
            return;
          }

          const greetEl = document.getElementById("greeting");
          const hour = new Date().getHours();
          const sal =
            hour < 12
              ? "Good Morning"
              : hour < 18
              ? "Good Afternoon"
              : "Good Evening";
          greetEl.textContent = `${sal}, ${
            userDoc.data().firstName || "Responder"
          }`;

          initMap();
          loadEmergencies(user.uid);
        } catch (err) {
          console.error("Error initializing dashboard:", err);
          showError("Failed to load dashboard: " + err.message);
        } finally {
          hideLoading();
        }
      });

      function loadEmergencies(userId) {
        const alertsGeoCol = geoFirestore.collection("helpRequests");
        alertsGeoCol
          .near({
            center: new firebase.firestore.GeoPoint(9.082, 8.6753),
            radius: 2,
          })
          .where("status", "==", "active")
          .onSnapshot((snapshot) => {
            snapshot.docChanges().forEach((change) => {
              const emergency = { id: change.doc.id, ...change.doc.data() };
              if (change.type === "added") {
                emergencies.push(emergency);
                addEmergencyToMap(emergency);
                addEmergencyToList(emergency, userId);
                playAlarm();
                showNotification(
                  `New ${emergency.type} request from ${emergency.name}`
                );
              } else if (change.type === "modified") {
                const index = emergencies.findIndex(
                  (e) => e.id === emergency.id
                );
                if (index !== -1) {
                  emergencies[index] = emergency;
                  updateEmergencyInList(emergency, userId);
                }
              }
            });
          });
      }

      async function addEmergencyToMap(emergency) {
        const marker = L.marker([
          emergency.coordinates.latitude,
          emergency.coordinates.longitude,
        ]).addTo(map);
        marker.bindTooltip(
          `Patient: ${emergency.name}<br>Address: ${emergency.address}`
        );
        marker.on("click", async () => {
          const patientDoc = await getDoc(
            doc(db, "users", emergency.patientId)
          );
          const patientData = patientDoc.exists() ? patientDoc.data() : {};
          marker
            .bindPopup(
              `
      <b>${patientData.firstName || "Unknown"} ${
                patientData.lastName || ""
              }</b><br/>
      Contact: ${patientData.phone || "N/A"}<br/>
      Lat: ${emergency.coordinates.latitude.toFixed(5)}<br/>
      Lng: ${emergency.coordinates.longitude.toFixed(5)}
    `
            )
            .openPopup();
        });
        map.setView(
          [emergency.coordinates.latitude, emergency.coordinates.longitude],
          14
        );

        const hospitals = await fetchNearbyHospitals(
          emergency.coordinates.latitude,
          emergency.coordinates.longitude
        );
        hospitals.forEach((hospital) => {
          L.marker(
            [hospital.geometry.location.lat, hospital.geometry.location.lng],
            {
              icon: L.icon({
                iconUrl:
                  "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
                iconSize: [25, 25],
              }),
            }
          )
            .addTo(map)
            .bindTooltip(hospital.name);
        });
      }

      function addEmergencyToList(emergency, userId) {
        const list =
          emergency.assignedTo === userId
            ? document.getElementById("assignedList")
            : document.getElementById("unassignedList");
        const item = document.createElement("div");
        item.className =
          emergency.assignedTo === userId
            ? "assignment-item"
            : "unassigned-item";
        item.dataset.id = emergency.id;
        item.innerHTML = `
    <div class="emergency-details">
      <h3><i class="fas fa-user-injured"></i> ${emergency.name}</h3>
      <p><i class="fas fa-map-marker-alt"></i> ${emergency.address}</p>
      <p><i class="fas fa-clock"></i> Requested at: ${new Date(
        emergency.createdAt.toDate()
      ).toLocaleString()}</p>
      <p class="status"><i class="fas fa-info-circle"></i> Status: ${
        emergency.status
      }</p>
    </div>
    ${
      emergency.assignedTo === userId
        ? `<button onclick="viewDetails('${emergency.id}')" class="btn btn-primary">View Details</button>`
        : `<button onclick="assignToMe('${emergency.id}')" class="btn btn-accent">Assign to Me</button>`
    }
  `;
        list.appendChild(item);
      }

      function updateEmergencyInList(emergency, userId) {
        const item = document.querySelector(
          `.emergency-item[data-id="${emergency.id}"]`
        );
        if (item) {
          item.querySelector(
            ".status"
          ).innerHTML = `<i class="fas fa-info-circle"></i> Status: ${emergency.status}`;
        }
      }

      async function assignToMe(id) {
        if (!auth.currentUser) {
          showError("No authenticated user");
          return;
        }
        try {
          await updateDoc(doc(db, "helpRequests", id), {
            assignedTo: auth.currentUser.uid,
            status: "Assigned",
          });
          showSuccess("Emergency assigned successfully");
        } catch (error) {
          console.error("Error assigning emergency:", error);
          showError("Failed to assign emergency: " + error.message);
        }
      }

      function viewDetails(id) {
        const emergency = emergencies.find((e) => e.id === id);
        if (emergency) {
          currentEmergency = emergency;
          document.getElementById("modalTitle").textContent = emergency.name;
          document.getElementById("modalAddress").textContent =
            emergency.address;
          document.getElementById("modalRequestedAt").textContent = new Date(
            emergency.createdAt.toDate()
          ).toLocaleString();
          document.getElementById("modalType").textContent =
            emergency.type === "gps" ? "GPS Request" : "Voice Call";
          document.getElementById("modalContact").textContent =
            emergency.phone || "N/A";
          document.getElementById(
            "modalCoordinates"
          ).textContent = `${emergency.coordinates.latitude.toFixed(
            5
          )}, ${emergency.coordinates.longitude.toFixed(5)}`;
          document.getElementById("statusSelect").value = emergency.status;
          document.getElementById("emergencyModal").classList.add("show");
        }
      }

      document.querySelector(".close").onclick = () => {
        document.getElementById("emergencyModal").classList.remove("show");
      };

      document.getElementById("saveStatus").onclick = async () => {
        const newStatus = document.getElementById("statusSelect").value;
        try {
          await updateDoc(doc(db, "helpRequests", currentEmergency.id), {
            status: newStatus,
          });
          showSuccess(`Status updated to ${newStatus}`);
          document.getElementById("emergencyModal").classList.remove("show");
        } catch (error) {
          console.error("Error updating status:", error);
          showError("Failed to update status: " + error.message);
        }
      };

      document
        .getElementById("logoutBtn")
        .addEventListener("click", async () => {
          try {
            showLoading();
            await signOut(auth);
            window.location.href = "/index.html";
          } catch (error) {
            console.error("Error signing out:", error);
            showError("Failed to sign out");
          } finally {
            hideLoading();
          }
        });

      document.getElementById("navToggle").addEventListener("click", () => {
        document.getElementById("navMenu").classList.toggle("open");
      });
    </script>
  </body>
</html>
