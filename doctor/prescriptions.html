<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prescription Page</title>
    <script src="https://cdn.tail yıllık.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
    <style>
      body {
        font-family: "Arial", sans-serif;
        background-color: #f0f4f8;
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
      }
      .modal-content {
        background: white;
        margin: 10% auto;
        padding: 20px;
        width: 80%;
        max-width: 500px;
        border-radius: 8px;
      }
    </style>
  </head>
  <body class="p-6">
    <!-- Header -->
    <header class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold">Dr. John Doe</h1>
      <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded">
        Logout
      </button>
    </header>

    <!-- Navigation -->
    <nav class="bg-gray-800 text-white p-4 rounded mb-6">
      <ul class="flex space-x-6">
        <li><a href="doctor/doctor.html" class="hover:underline">Dashboard</a></li>
        <li><a href="doctor/appointments.html" class="hover:underline">Appointments</a></li>
        <li><a href="doctor/records.html" class="hover:underline">Records</a></li>
        <li><a href="doctor/note.html" class="hover:underline">Clinical Notes</a></li>
        <li><a href="doctor/prescriptions.html" class="underline">Prescriptions</a></li>
      </ul>
    </nav>

    <!-- Main Content -->
    <main class="bg-white p-6 rounded shadow">
      <h2 class="text-xl font-semibold mb-4">
        Prescriptions for <span id="patientName">Loading...</span>
      </h2>
      <button
        id="newPrescriptionBtn"
        class="bg-blue-500 text-white px-4 py-2 rounded mb-4"
      >
        New Prescription
      </button>

      <!-- Prescription List -->
      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
          <thead>
            <tr class="bg-gray-200">
              <th class="p-2">Medication</th>
              <th class="p-2">Dosage</th>
              <th class="p-2">Status</th>
              <th class="p-2">Actions</th>
            </tr>
          </thead>
          <tbody id="prescriptionList"></tbody>
        </table>
      </div>
    </main>

    <!-- New/Edit Prescription Modal -->
    <div id="prescriptionModal" class="modal">
      <div class="modal-content">
        <h3 class="text-lg font-semibold mb-4">Prescription Details</h3>
        <input type="hidden" id="prescriptionId" />
        <div class="mb-4">
          <label class="block text-sm font-medium">Medication Name</label>
          <input
            id="medicationName"
            type="text"
            class="w-full p-2 border rounded"
          />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium">Dosage</label>
          <input id="dosage" type="text" class="w-full p-2 border rounded" />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium">Frequency</label>
          <input id="frequency" type="text" class="w-full p-2 border rounded" />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium">Duration</label>
          <input id="duration" type="text" class="w-full p-2 border rounded" />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium">Notes</label>
          <textarea id="notes" class="w-full p-2 border rounded"></textarea>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium">Valid Until</label>
          <input
            id="validUntil"
            type="date"
            class="w-full p-2 border rounded"
          />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium">Status</label>
          <select id="status" class="w-full p-2 border rounded">
            <option value="active">Active</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
        <div class="flex justify-end space-x-2">
          <button
            id="savePrescriptionBtn"
            class="bg-green-500 text-white px-4 py-2 rounded"
          >
            Save
          </button>
          <button
            id="closeModalBtn"
            class="bg-gray-500 text-white px-4 py-2 rounded"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <script>
      // Firebase Configuration (Replace with your own config)
      const firebaseConfig = {
        apiKey: "AIzaSyCpMkpU9YeB3HNpzk0_fwswSf9TQwb_Xdg",
        authDomain: "hospitalmanagtsystem.firebaseapp.com",
        databaseURL:
          "https://hospitalmanagtsystem-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "hospitalmanagtsystem",
        storageBucket: "hospitalmanagtsystem.firebasestorage.app",
        messagingSenderId: "771158568788",
        appId: "1:771158568788:web:e47f16ea2577fa1e8762c1",
      };
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const storage = getStorage(app);

      // DOM Elements
      const patientNameEl = document.getElementById("patientName");
      const prescriptionListEl = document.getElementById("prescriptionList");
      const newPrescriptionBtn = document.getElementById("newPrescriptionBtn");
      const prescriptionModal = document.getElementById("prescriptionModal");
      const savePrescriptionBtn = document.getElementById(
        "savePrescriptionBtn"
      );
      const closeModalBtn = document.getElementById("closeModalBtn");
      const logoutBtn = document.getElementById("logoutBtn");

      // Prescription Form Fields
      const prescriptionIdEl = document.getElementById("prescriptionId");
      const medicationNameEl = document.getElementById("medicationName");
      const dosageEl = document.getElementById("dosage");
      const frequencyEl = document.getElementById("frequency");
      const durationEl = document.getElementById("duration");
      const notesEl = document.getElementById("notes");
      const validUntilEl = document.getElementById("validUntil");
      const statusEl = document.getElementById("status");

      let currentPatientId = null;

      // Authentication Check
      auth.onAuthStateChanged((user) => {
        if (!user) window.location.href = "login.html"; // Redirect to login if not authenticated
      });

      // Fetch Current Patient (assuming from an appointment system)
      async function fetchCurrentPatient() {
        // Simulate fetching the patient currently being seen (replace with actual logic)
        const appointmentRef = db
          .collection("appointments")
          .where("doctorId", "==", auth.currentUser.uid)
          .where("status", "==", "active")
          .limit(1);
        const snapshot = await appointmentRef.get();
        if (!snapshot.empty) {
          const appointment = snapshot.docs[0].data();
          currentPatientId = appointment.patientId;
          const patientRef = await db
            .collection("patients")
            .doc(currentPatientId)
            .get();
          patientNameEl.textContent = patientRef.data().name;
          loadPrescriptions();
        } else {
          patientNameEl.textContent = "No active appointment";
        }
      }

      // Load Prescriptions for the Current Patient
      async function loadPrescriptions() {
        if (!currentPatientId) return;
        prescriptionListEl.innerHTML = "";
        const prescriptionsRef = db
          .collection("prescriptions")
          .where("patientId", "==", currentPatientId);
        const snapshot = await prescriptionsRef.get();
        snapshot.forEach((doc) => {
          const data = doc.data();
          const row = document.createElement("tr");
          row.innerHTML = `
          <td class="p-2">${data.medicationName}</td>
          <td class="p-2">${data.dosage}</td>
          <td class="p-2">${data.status}</td>
          <td class="p-2">
            <button onclick="editPrescription('${doc.id}')" class="bg-yellow-500 text-white px-2 py-1 rounded">Edit</button>
            <button onclick="deletePrescription('${doc.id}')" class="bg-red-500 text-white px-2 py-1 rounded">Delete</button>
          </td>
        `;
          prescriptionListEl.appendChild(row);
        });
      }

      // Open Modal for New Prescription
      newPrescriptionBtn.addEventListener("click", () => {
        prescriptionIdEl.value = "";
        medicationNameEl.value = "";
        dosageEl.value = "";
        frequencyEl.value = "";
        durationEl.value = "";
        notesEl.value = "";
        validUntilEl.value = "";
        statusEl.value = "active";
        prescriptionModal.style.display = "block";
      });

      // Close Modal
      closeModalBtn.addEventListener("click", () => {
        prescriptionModal.style.display = "none";
      });

      // Save Prescription
      savePrescriptionBtn.addEventListener("click", async () => {
        const prescriptionData = {
          patientId: currentPatientId,
          doctorId: auth.currentUser.uid,
          medicationName: medicationNameEl.value,
          dosage: dosageEl.value,
          frequency: frequencyEl.value,
          duration: durationEl.value,
          notes: notesEl.value,
          validUntil: validUntilEl.value,
          status: statusEl.value,
          createdAt: new Date().toISOString(),
        };

        try {
          if (prescriptionIdEl.value) {
            await db
              .collection("prescriptions")
              .doc(prescriptionIdEl.value)
              .update(prescriptionData);
          } else {
            await db.collection("prescriptions").add(prescriptionData);
          }
          prescriptionModal.style.display = "none";
          loadPrescriptions();
        } catch (error) {
          alert("Error saving prescription: " + error.message);
        }
      });

      // Edit Prescription
      window.editPrescription = async function (id) {
        const doc = await db.collection("prescriptions").doc(id).get();
        const data = doc.data();
        prescriptionIdEl.value = id;
        medicationNameEl.value = data.medicationName;
        dosageEl.value = data.dosage;
        frequencyEl.value = data.frequency;
        durationEl.value = data.duration;
        notesEl.value = data.notes;
        validUntilEl.value = data.validUntil;
        statusEl.value = data.status;
        prescriptionModal.style.display = "block";
      };

      // Delete Prescription
      window.deletePrescription = async function (id) {
        if (confirm("Are you sure you want to delete this prescription?")) {
          await db.collection("prescriptions").doc(id).delete();
          loadPrescriptions();
        }
      };

      // Logout
      logoutBtn.addEventListener("click", () => {
        auth.signOut();
      });

      // Initialize
      fetchCurrentPatient();
    </script>
  </body>
</html>
