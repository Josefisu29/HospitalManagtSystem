<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HMS – Doctor Prescriptions</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-firestore-compat.js"></script>
    <style>
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        max-width: 500px;
        width: 90%;
        position: relative;
      }
      .modal-content .close {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.5rem;
        cursor: pointer;
      }
      .error-message {
        color: #e53e3e;
        text-align: center;
        margin-bottom: 1rem;
        font-weight: 500;
      }
      .success-message {
        color: #38a169;
        text-align: center;
        margin-bottom: 1rem;
        font-weight: 500;
      }
      .loading-spinner {
        width: 24px;
        height: 24px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #0052cc;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body class="p-6 bg-gray-100">
    <div id="loading" class="loading-spinner" style="display: none"></div>
    <div id="message" class="error-message"></div>
    <header class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold" id="greeting">Dr.</h1>
      <button
        id="logoutBtn"
        class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"
      >
        Logout
      </button>
    </header>
    <nav class="bg-gray-800 text-white p-4 rounded mb-6">
      <ul class="flex space-x-6">
        <li><a href="doctor.html" class="hover:underline">Dashboard</a></li>
        <li>
          <a href="appointments.html" class="hover:underline">Appointments</a>
        </li>
        <li><a href="records.html" class="hover:underline">Records</a></li>
        <li><a href="note.html" class="hover:underline">Clinical Notes</a></li>
        <li>
          <a href="prescriptions.html" class="underline">Prescriptions</a>
        </li>
      </ul>
    </nav>
    <main class="bg-white p-6 rounded shadow">
      <h2 class="text-xl font-semibold mb-4">
        Prescriptions for <span id="patientName">All Patients</span>
      </h2>
      <button
        id="newPrescriptionBtn"
        class="bg-blue-500 text-white px-4 py-2 rounded mb-4 hover:bg-blue-600"
      >
        New Prescription
      </button>
      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
          <thead>
            <tr class="bg-gray-200">
              <th class="p-2">Patient</th>
              <th class="p-2">Medication</th>
              <th class="p-2">Dosage</th>
              <th class="p-2">Status</th>
              <th class="p-2">Date</th>
              <th class="p-2">Actions</th>
            </tr>
          </thead>
          <tbody id="prescriptionsList"></tbody>
        </table>
      </div>
    </main>
    <div id="prescriptionModal" class="modal">
      <div class="modal-content">
        <span class="close" id="closePrescriptionModal">×</span>
        <h3 id="prescriptionModalTitle" class="text-xl font-semibold mb-4">
          New Prescription
        </h3>
        <form id="prescriptionForm" class="space-y-4">
          <input type="hidden" id="prescriptionId" />
          <div>
            <label class="block text-sm font-medium mb-1">Patient ID</label>
            <input
              id="patientId"
              type="text"
              class="w-full p-2 border rounded"
              required
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Medication</label>
            <input
              id="medication"
              type="text"
              class="w-full p-2 border rounded"
              required
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Dosage</label>
            <input
              id="dosage"
              type="text"
              class="w-full p-2 border rounded"
              required
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Instructions</label>
            <textarea
              id="instructions"
              class="w-full p-2 border rounded"
              rows="4"
            ></textarea>
          </div>
          <div class="flex justify-end space-x-2">
            <button
              type="submit"
              class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"
            >
              Save
            </button>
            <button
              type="button"
              id="cancelPrescriptionBtn"
              class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.x.x/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.x.x/firebase-auth.js";
      import {
        getFirestore,
        collection,
        query,
        where,
        onSnapshot,
        doc,
        getDoc,
        addDoc,
        updateDoc,
        Timestamp,
        enableIndexedDbPersistence,
        orderBy,
      } from "https://www.gstatic.com/firebasejs/9.x.x/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCpMkpU9YeB3HNpzk0_fwswSf9TQwb_Xdg",
        authDomain: "hospitalmanagtsystem.firebaseapp.com",
        projectId: "hospitalmanagtsystem",
        storageBucket: "hospitalmanagtsystem.firebasestorage.app",
        messagingSenderId: "771158568788",
        appId: "1:771158568788:web:e47f16ea2577fa1e8762c1",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      let currentDoctorId = null;
      let currentUserRole = null;

      enableIndexedDbPersistence(db).catch((err) => {
        if (err.code === "failed-precondition") {
          console.warn(
            "Multiple tabs open, persistence can only be enabled in one tab at a time."
          );
        } else if (err.code === "unimplemented") {
          console.warn("The current browser does not support persistence.");
        }
      });

      function showLoading() {
        document.getElementById("loading").style.display = "block";
      }

      function hideLoading() {
        document.getElementById("loading").style.display = "none";
      }

      function showMessage(message, type = "error") {
        const messageElement = document.getElementById("message");
        messageElement.textContent = message;
        messageElement.className =
          type === "error" ? "error-message" : "success-message";
        setTimeout(() => (messageElement.textContent = ""), 5000);
      }

      function validatePrescriptionForm() {
        const patientId = document.getElementById("patientId").value;
        const medication = document.getElementById("medication").value;
        const dosage = document.getElementById("dosage").value;

        if (!patientId) {
          showMessage("Patient ID is required");
          return false;
        }
        if (!medication) {
          showMessage("Medication is required");
          return false;
        }
        if (!dosage) {
          showMessage("Dosage is required");
          return false;
        }
        return true;
      }

      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "/index.html";
          return;
        }
        try {
          const idTokenResult = await user.getIdTokenResult();
          currentUserRole = idTokenResult.claims.role;
          if (currentUserRole !== "doctor") {
            await signOut(auth);
            window.location.href = "/unauthorized.html";
            return;
          }
          currentDoctorId = user.uid;
          const doctorDoc = await getDoc(doc(db, "doctors", user.uid));
          if (doctorDoc.exists()) {
            const doctor = doctorDoc.data();
            document.getElementById(
              "greeting"
            ).textContent = `Dr. ${doctor.firstName} ${doctor.lastName}`;
            loadPrescriptions();
          } else {
            showMessage("Doctor profile not found");
          }
        } catch (error) {
          showMessage("Failed to load user profile: " + error.message);
        }
      });

      function loadPrescriptions() {
        showLoading();
        const prescriptionsQuery = query(
          collection(db, "prescriptions"),
          where("doctorId", "==", currentDoctorId),
          orderBy("createdAt", "desc")
        );

        onSnapshot(
          prescriptionsQuery,
          async (snapshot) => {
            const prescriptionsList =
              document.getElementById("prescriptionsList");
            prescriptionsList.innerHTML = "";

            if (snapshot.empty) {
              prescriptionsList.innerHTML =
                "<tr><td colspan='6' class='p-2 text-center'>No prescriptions found</td></tr>";
            } else {
              for (const doc of snapshot.docs) {
                const prescription = doc.data();
                const patientDoc = await getDoc(
                  doc(db, "users", prescription.patientId)
                );
                const patientName = patientDoc.exists()
                  ? `${patientDoc.data().firstName} ${
                      patientDoc.data().lastName
                    }`
                  : "Unknown";
                const row = document.createElement("tr");
                row.innerHTML = `
                  <td class="p-2">${patientName}</td>
                  <td class="p-2">${prescription.medication}</td>
                  <td class="p-2">${prescription.dosage}</td>
                  <td class="p-2">${prescription.status || "Pending"}</td>
                  <td class="p-2">${prescription.createdAt
                    .toDate()
                    .toLocaleDateString()}</td>
                  <td class="p-2">
                    <button class="edit-prescription-btn bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600" data-id="${
                      doc.id
                    }">Edit</button>
                  </td>
                `;
                prescriptionsList.appendChild(row);
              }
              addPrescriptionEventListeners();
            }
            hideLoading();
          },
          (error) => {
            showMessage("Failed to load prescriptions: " + error.message);
            hideLoading();
          }
        );
      }

      function addPrescriptionEventListeners() {
        document
          .querySelectorAll(".edit-prescription-btn")
          .forEach((button) => {
            button.addEventListener("click", (e) => {
              const id = e.target.dataset.id;
              editPrescription(id);
            });
          });
      }

      async function editPrescription(id) {
        showLoading();
        try {
          const docRef = doc(db, "prescriptions", id);
          const docSnap = await getDoc(docRef);
          if (docSnap.exists()) {
            const prescription = docSnap.data();
            document.getElementById("prescriptionId").value = id;
            document.getElementById("patientId").value = prescription.patientId;
            document.getElementById("medication").value =
              prescription.medication;
            document.getElementById("dosage").value = prescription.dosage;
            document.getElementById("instructions").value =
              prescription.instructions || "";
            document.getElementById("prescriptionModalTitle").textContent =
              "Edit Prescription";
            document.getElementById("prescriptionModal").style.display = "flex";
          } else {
            showMessage("Prescription not found");
          }
        } catch (error) {
          showMessage("Failed to load prescription: " + error.message);
        } finally {
          hideLoading();
        }
      }

      document
        .getElementById("newPrescriptionBtn")
        .addEventListener("click", () => {
          document.getElementById("prescriptionId").value = "";
          document.getElementById("patientId").value = "";
          document.getElementById("medication").value = "";
          document.getElementById("dosage").value = "";
          document.getElementById("instructions").value = "";
          document.getElementById("prescriptionModalTitle").textContent =
            "New Prescription";
          document.getElementById("prescriptionModal").style.display = "flex";
        });

      document
        .getElementById("closePrescriptionModal")
        .addEventListener("click", () => {
          document.getElementById("prescriptionModal").style.display = "none";
        });

      document
        .getElementById("cancelPrescriptionBtn")
        .addEventListener("click", () => {
          document.getElementById("prescriptionModal").style.display = "none";
        });

      document
        .getElementById("prescriptionForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          if (!validatePrescriptionForm()) {
            return;
          }

          showLoading();
          const prescriptionData = {
            patientId: document.getElementById("patientId").value,
            doctorId: currentDoctorId,
            medication: document.getElementById("medication").value,
            dosage: document.getElementById("dosage").value,
            instructions: document.getElementById("instructions").value || null,
            status: "pending",
            createdAt: Timestamp.now(),
            updatedAt: Timestamp.now(),
          };

          try {
            const patientDoc = await getDoc(
              doc(db, "users", prescriptionData.patientId)
            );
            if (!patientDoc.exists()) {
              showMessage("Invalid patient ID");
              hideLoading();
              return;
            }
            prescriptionData.patientName = `${patientDoc.data().firstName} ${
              patientDoc.data().lastName
            }`;

            if (document.getElementById("prescriptionId").value) {
              await updateDoc(
                doc(
                  db,
                  "prescriptions",
                  document.getElementById("prescriptionId").value
                ),
                prescriptionData
              );
              showMessage("Prescription updated successfully", "success");
            } else {
              await addDoc(collection(db, "prescriptions"), prescriptionData);
              showMessage("Prescription created successfully", "success");
            }
            document.getElementById("prescriptionModal").style.display = "none";
            loadPrescriptions();
          } catch (error) {
            showMessage("Failed to save prescription: " + error.message);
          } finally {
            hideLoading();
          }
        });

      document
        .getElementById("logoutBtn")
        .addEventListener("click", async () => {
          showLoading();
          try {
            await signOut(auth);
            window.location.href = "/index.html";
          } catch (error) {
            showMessage("Failed to sign out: " + error.message);
          } finally {
            hideLoading();
          }
        });
    </script>
  </body>
</html>
